<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Cria√ß√£o de Despesas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Debug - Cria√ß√£o de Despesas</h1>
    <div id="output"></div>
    <button onclick="testExpenseCreation()">Testar Cria√ß√£o de Despesa</button>
    
    <script>
        const supabaseUrl = 'https://jjqhgvnzjwkhsrebcjvn.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcWhndm56andraHNyZWJjanZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTEyOTMsImV4cCI6MjA2Njk4NzI5M30.3lQZZ1l0umn1PWtS7EcoFvkZBgB9pZcqYZg92LhhXhw'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function log(message) {
            const output = document.getElementById('output')
            output.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>'
            console.log(message)
        }
        
        async function testExpenseCreation() {
            try {
                log('üîç Iniciando teste de cria√ß√£o de despesa...')
                
                // Verificar autentica√ß√£o
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                if (authError) {
                    log('‚ùå Erro de autentica√ß√£o: ' + authError.message)
                    return
                }
                
                if (!user) {
                    log('‚ùå Usu√°rio n√£o autenticado')
                    return
                }
                
                log('‚úÖ Usu√°rio autenticado: ' + user.email)
                
                // Buscar organiza√ß√µes do usu√°rio
                const { data: organizations, error: orgError } = await supabase
                    .from('user_organizations')
                    .select(`
                        organization_id,
                        role,
                        organizations!inner(*)
                    `)
                    .eq('user_id', user.id)
                
                if (orgError) {
                    log('‚ùå Erro ao buscar organiza√ß√µes: ' + orgError.message)
                    return
                }
                
                if (!organizations || organizations.length === 0) {
                    log('‚ùå Nenhuma organiza√ß√£o encontrada para o usu√°rio')
                    return
                }
                
                const organization = organizations[0]
                log('‚úÖ Organiza√ß√£o encontrada: ' + organization.organizations.name + ' (ID: ' + organization.organization_id + ')')
                
                // Tentar criar uma despesa de teste
                const testExpense = {
                    title: 'Despesa de Teste - ' + new Date().toLocaleString(),
                    description: 'Despesa criada para teste de debug',
                    amount: 100.50,
                    organization_id: organization.organization_id,
                    expense_date: new Date().toISOString().split('T')[0],
                    payment_method: 'credit_card',
                    status: 'pending'
                }
                
                log('üìù Tentando criar despesa: ' + JSON.stringify(testExpense, null, 2))
                
                const { data: expense, error: expenseError } = await supabase
                    .from('expenses')
                    .insert([testExpense])
                    .select(`
                        *,
                        category:categories(*)
                    `)
                    .single()
                
                if (expenseError) {
                    log('‚ùå Erro ao criar despesa: ' + expenseError.message)
                    log('‚ùå Detalhes do erro: ' + JSON.stringify(expenseError, null, 2))
                    return
                }
                
                if (expense) {
                    log('‚úÖ Despesa criada com sucesso!')
                    log('üìã Dados da despesa: ' + JSON.stringify(expense, null, 2))
                    
                    // Verificar se a despesa foi realmente salva
                    const { data: savedExpense, error: fetchError } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('id', expense.id)
                        .single()
                    
                    if (fetchError) {
                        log('‚ùå Erro ao verificar despesa salva: ' + fetchError.message)
                    } else if (savedExpense) {
                        log('‚úÖ Despesa confirmada no banco de dados!')
                    } else {
                        log('‚ùå Despesa n√£o encontrada no banco de dados')
                    }
                } else {
                    log('‚ùå Nenhuma despesa retornada')
                }
                
            } catch (error) {
                log('‚ùå Erro geral: ' + error.message)
                console.error('Erro completo:', error)
            }
        }
        
        // Executar teste automaticamente ao carregar a p√°gina
        window.addEventListener('load', () => {
            log('üöÄ P√°gina carregada, executando teste autom√°tico...')
            setTimeout(testExpenseCreation, 1000)
        })
    </script>
</body>
</html>