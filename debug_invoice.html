<!DOCTYPE html>
<html>
<head>
    <title>Debug Invoice Creation</title>
</head>
<body>
    <h1>Debug Invoice Creation</h1>
    <button onclick="testInvoiceCreation()">Testar Cria√ß√£o de Fatura</button>
    <div id="output"></div>

    <script type="module">
        import { supabase } from './src/lib/supabase.js';
        
        window.testInvoiceCreation = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Iniciando teste...</p>';
            
            try {
                // Verificar sess√£o
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                output.innerHTML += `<p>Sess√£o: ${session?.user?.id || 'N√£o autenticado'}</p>`;
                
                if (!session?.user) {
                    output.innerHTML += '<p style="color: red;">‚ùå Usu√°rio n√£o autenticado</p>';
                    return;
                }
                
                // Verificar organiza√ß√µes
                const { data: userOrgs, error: userOrgsError } = await supabase
                    .from('user_organizations')
                    .select('*')
                    .eq('user_id', session.user.id);
                
                output.innerHTML += `<p>Organiza√ß√µes: ${userOrgs?.length || 0}</p>`;
                
                if (!userOrgs || userOrgs.length === 0) {
                    output.innerHTML += '<p style="color: red;">‚ùå Nenhuma organiza√ß√£o encontrada</p>';
                    return;
                }
                
                const orgId = userOrgs[0].organization_id;
                
                // Verificar clientes
                const { data: clients, error: clientsError } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('organization_id', orgId);
                
                output.innerHTML += `<p>Clientes: ${clients?.length || 0}</p>`;
                
                if (!clients || clients.length === 0) {
                    output.innerHTML += '<p style="color: red;">‚ùå Nenhum cliente encontrado</p>';
                    return;
                }
                
                // Tentar criar fatura
                const testInvoice = {
                    client_id: clients[0].id,
                    organization_id: orgId,
                    invoice_number: 'TEST-' + Date.now(),
                    issue_date: new Date().toISOString().split('T')[0],
                    due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: 'draft',
                    subtotal: 100.00,
                    tax_amount: 0.00,
                    discount_amount: 0.00,
                    total_amount: 100.00,
                    notes: 'Fatura de teste',
                    payment_terms: 'Pagamento em 30 dias'
                };
                
                output.innerHTML += `<p>Dados da fatura: ${JSON.stringify(testInvoice, null, 2)}</p>`;
                
                const { data: invoice, error: invoiceError } = await supabase
                    .from('invoices')
                    .insert([testInvoice])
                    .select()
                    .single();
                
                if (invoiceError) {
                    output.innerHTML += `<p style="color: red;">‚ùå Erro: ${JSON.stringify(invoiceError, null, 2)}</p>`;
                } else {
                    output.innerHTML += `<p style="color: green;">‚úÖ Fatura criada: ${invoice.id}</p>`;
                    
                    // Limpar
                    await supabase.from('invoices').delete().eq('id', invoice.id);
                    output.innerHTML += '<p>üßπ Fatura de teste removida</p>';
                }
                
            } catch (error) {
                output.innerHTML += `<p style="color: red;">‚ùå Erro geral: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>