<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Autentica√ß√£o e Cria√ß√£o de Despesa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Teste de Autentica√ß√£o e Cria√ß√£o de Despesa</h1>
    <div id="output"></div>
    
    <div style="margin: 20px 0;">
        <h3>Login (se necess√°rio)</h3>
        <input type="email" id="email" placeholder="Email" value="" />
        <input type="password" id="password" placeholder="Senha" value="" />
        <button onclick="doLogin()">Login</button>
    </div>
    
    <button onclick="testAuthAndExpense()">Testar Autentica√ß√£o e Cria√ß√£o de Despesa</button>
    
    <script>
        const supabaseUrl = 'https://jjqhgvnzjwkhsrebcjvn.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcWhndm56andraHNyZWJjanZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MTEyOTMsImV4cCI6MjA2Njk4NzI5M30.3lQZZ1l0umn1PWtS7EcoFvkZBgB9pZcqYZg92LhhXhw'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function log(message) {
            const output = document.getElementById('output')
            output.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>'
            console.log(message)
        }
        
        async function doLogin() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value
            
            if (!email || !password) {
                log('‚ùå Por favor, preencha email e senha')
                return
            }
            
            try {
                log('üîê Fazendo login...')
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })
                
                if (error) {
                    log('‚ùå Erro no login: ' + error.message)
                } else {
                    log('‚úÖ Login realizado com sucesso!')
                    log('üë§ Usu√°rio: ' + data.user.email)
                }
            } catch (error) {
                log('‚ùå Erro no login: ' + error.message)
            }
        }
        
        async function testAuthAndExpense() {
            try {
                log('üîç Iniciando teste completo...')
                
                // 1. Verificar autentica√ß√£o
                log('1Ô∏è‚É£ Verificando autentica√ß√£o...')
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                
                if (authError) {
                    log('‚ùå Erro de autentica√ß√£o: ' + authError.message)
                    log('üí° Tente fazer login usando o formul√°rio acima')
                    return
                }
                
                if (!user) {
                    log('‚ùå Usu√°rio n√£o autenticado')
                    log('üí° Tente fazer login usando o formul√°rio acima')
                    return
                }
                
                log('‚úÖ Usu√°rio autenticado: ' + user.email)
                log('üÜî User ID: ' + user.id)
                
                // 2. Buscar organiza√ß√µes do usu√°rio
                log('2Ô∏è‚É£ Buscando organiza√ß√µes do usu√°rio...')
                const { data: userOrgs, error: userOrgError } = await supabase
                    .from('user_organizations')
                    .select(`
                        organization_id,
                        role,
                        organizations!inner(id, name)
                    `)
                    .eq('user_id', user.id)
                
                if (userOrgError) {
                    log('‚ùå Erro ao buscar organiza√ß√µes: ' + userOrgError.message)
                    return
                }
                
                if (!userOrgs || userOrgs.length === 0) {
                    log('‚ùå Nenhuma organiza√ß√£o encontrada para o usu√°rio')
                    log('üí° O usu√°rio precisa estar associado a uma organiza√ß√£o')
                    return
                }
                
                const org = userOrgs[0]
                log('‚úÖ Organiza√ß√£o encontrada: ' + org.organizations.name)
                log('üÜî Organization ID: ' + org.organization_id)
                log('üë§ Role: ' + org.role)
                
                // 3. Tentar criar despesa
                log('3Ô∏è‚É£ Tentando criar despesa...')
                const testExpense = {
                    title: 'Teste Completo - ' + new Date().toLocaleString(),
                    description: 'Despesa de teste para verificar autentica√ß√£o',
                    amount: 25.99,
                    organization_id: org.organization_id,
                    expense_date: new Date().toISOString().split('T')[0],
                    payment_method: 'credit_card',
                    status: 'pending'
                }
                
                log('üìù Dados da despesa: ' + JSON.stringify(testExpense, null, 2))
                
                const { data: expense, error: expenseError } = await supabase
                    .from('expenses')
                    .insert([testExpense])
                    .select('*')
                    .single()
                
                if (expenseError) {
                    log('‚ùå ERRO ao criar despesa:')
                    log('‚ùå Mensagem: ' + expenseError.message)
                    log('‚ùå C√≥digo: ' + expenseError.code)
                    log('‚ùå Detalhes: ' + JSON.stringify(expenseError.details))
                    log('‚ùå Hint: ' + expenseError.hint)
                    
                    // Verificar se √© problema de RLS
                    if (expenseError.code === '42501' || expenseError.message.includes('policy')) {
                        log('üîí Parece ser um problema de Row Level Security (RLS)')
                        log('üí° Verifique se as pol√≠ticas RLS est√£o configuradas corretamente')
                    }
                } else if (expense) {
                    log('‚úÖ SUCESSO! Despesa criada:')
                    log('üìã ID: ' + expense.id)
                    log('üìã T√≠tulo: ' + expense.title)
                    log('üìã Valor: R$ ' + expense.amount)
                    log('üìã Data: ' + expense.expense_date)
                    
                    // Verificar se foi realmente salva
                    log('4Ô∏è‚É£ Verificando se a despesa foi salva...')
                    const { data: savedExpense, error: fetchError } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('id', expense.id)
                        .single()
                    
                    if (fetchError) {
                        log('‚ùå Erro ao verificar despesa salva: ' + fetchError.message)
                    } else if (savedExpense) {
                        log('‚úÖ Despesa confirmada no banco de dados!')
                    } else {
                        log('‚ùå Despesa n√£o encontrada no banco')
                    }
                } else {
                    log('‚ùå Nenhuma despesa retornada (sem erro, mas sem dados)')
                }
                
                log('üèÅ Teste completo finalizado!')
                
            } catch (error) {
                log('‚ùå Erro JavaScript: ' + error.message)
                console.error('Erro completo:', error)
            }
        }
        
        // Auto-executar
        window.addEventListener('load', () => {
            setTimeout(testAuthAndExpense, 1000)
        })
    </script>
</body>
</html>